<div class="bg-gray-800 rounded-lg p-6 max-w-4xl mx-auto">
  <h1 class="text-3xl font-bold mb-6">Add New Movie</h1>
  
  <%= form_with model: [@movie], url: admin_movies_path, local: true, multipart: true, class: "space-y-6" do |form| %>
    <% if @movie.errors.any? %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        <h3 class="font-bold"><%= pluralize(@movie.errors.count, "error") %> prohibited this movie from being saved:</h3>
        <ul class="list-disc pl-5 mt-2">
          <% @movie.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= form.label :title, class: "block text-sm font-medium mb-2" %>
        <%= form.text_field :title, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :genre_id, "Genre", class: "block text-sm font-medium mb-2" %>
        <%= form.select :genre_id, options_from_collection_for_select(@genres, "id", "name"), { include_blank: "Select Genre" }, { class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" } %>
      </div>
      
      <div>
        <%= form.label :release_year, "Release Year", class: "block text-sm font-medium mb-2" %>
        <%= form.number_field :release_year, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :duration, "Duration (minutes)", class: "block text-sm font-medium mb-2" %>
        <%= form.number_field :duration, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :imdb_rating, "IMDb Rating", class: "block text-sm font-medium mb-2" %>
        <%= form.number_field :imdb_rating, step: 0.1, min: 0, max: 10, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :country, class: "block text-sm font-medium mb-2" %>
        <%= form.text_field :country, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :director, class: "block text-sm font-medium mb-2" %>
        <%= form.text_field :director, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
      
      <div>
        <%= form.label :cast, class: "block text-sm font-medium mb-2" %>
        <%= form.text_area :cast, rows: 3, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
      </div>
    </div>
    
    <div>
      <%= form.label :description, class: "block text-sm font-medium mb-2" %>
      <%= form.text_area :description, rows: 4, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= form.label :thumbnail, "Movie Thumbnail", class: "block text-sm font-medium mb-2" %>
        <%= form.file_field :thumbnail, accept: 'image/*', class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
        <p class="text-sm text-gray-400 mt-1">Upload a poster image (PNG, JPG, JPEG - Max 5MB)</p>
      </div>
      
      <div>
        <%= form.label :video, "Movie Video", class: "block text-sm font-medium mb-2" %>
        <%= form.file_field :video, accept: 'video/*', class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
        <p class="text-sm text-gray-400 mt-1">Upload the movie file (MP4, AVI, MOV - Max 100MB)</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <%= form.label :poster_url, "Poster URL (fallback)", class: "block text-sm font-medium mb-2" %>
        <%= form.url_field :poster_url, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
        <p class="text-sm text-gray-400 mt-1">External URL for poster image (used if no thumbnail uploaded)</p>
      </div>
      
      <div>
        <%= form.label :trailer_url, "Trailer URL (fallback)", class: "block text-sm font-medium mb-2" %>
        <%= form.url_field :trailer_url, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
        <p class="text-sm text-gray-400 mt-1">External URL for trailer/video (used if no video uploaded)</p>
      </div>
    </div>
    
    <!-- Advertising Section -->
    <div class="border-t border-gray-700 pt-6 mt-6">
      <h3 class="text-xl font-semibold text-white mb-4">Advertising Options</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div>
          <%= form.label :enable_ads, "Enable Pre-roll Ads", class: "block text-sm font-medium mb-2" %>
          <div class="flex items-center">
            <%= form.check_box :enable_ads, class: "mr-2 h-5 w-5 text-red-600 rounded focus:ring-red-500" %>
            <span class="text-gray-300">Show ads before movie playback</span>
          </div>
        </div>
        
        <div>
          <%= form.label :ad_frequency, "Ad Frequency (seconds)", class: "block text-sm font-medium mb-2" %>
          <%= form.number_field :ad_frequency, min: 30, max: 300, step: 30, value: 60, class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
          <p class="text-sm text-gray-400 mt-1">How often mid-roll ads appear</p>
        </div>
      </div>

      <div id="ads-container" class="space-y-4">
        <div class="flex justify-between items-center">
          <h4 class="text-lg font-medium text-white">Ad Campaigns</h4>
          <button type="button" id="add-ad-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
            + Add Ad
          </button>
        </div>
        
        <!-- Ad Template (hidden) -->
        <div id="ad-template" class="hidden bg-gray-700 p-4 rounded-lg">
          <div class="flex justify-between items-start mb-3">
            <h5 class="text-md font-medium text-white">Ad Campaign #<span class="ad-number">1</span></h5>
            <button type="button" class="remove-ad-btn text-red-400 hover:text-red-300">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= form.label :ad_title, "Ad Title", class: "block text-sm font-medium mb-1" %>
              <input type="text" name="movie[ads_attributes][0][title]" placeholder="Ad campaign name" class="w-full bg-gray-600 text-white rounded px-3 py-2">
            </div>
            
            <div>
              <%= form.label :ad_url, "Ad URL", class: "block text-sm font-medium mb-1" %>
              <input type="url" name="movie[ads_attributes][0][url]" placeholder="https://example.com/ad" class="w-full bg-gray-600 text-white rounded px-3 py-2">
            </div>
            
            <div>
              <%= form.label :ad_duration, "Duration (seconds)", class: "block text-sm font-medium mb-1" %>
              <input type="number" name="movie[ads_attributes][0][duration]" min="5" max="120" value="30" class="w-full bg-gray-600 text-white rounded px-3 py-2">
            </div>
            
            <div>
              <%= form.label :ad_position, "Position", class: "block text-sm font-medium mb-1" %>
              <select name="movie[ads_attributes][0][position]" class="w-full bg-gray-600 text-white rounded px-3 py-2">
                <option value="pre">Pre-roll</option>
                <option value="mid">Mid-roll</option>
                <option value="post">Post-roll</option>
              </select>
            </div>
          </div>
          
          <div class="mt-3">
            <%= form.label :ad_script, "Ad Script/Code", class: "block text-sm font-medium mb-1" %>
            <textarea name="movie[ads_attributes][0][script]" rows="3" placeholder="Paste your ad script or tracking code here" class="w-full bg-gray-600 text-white rounded px-3 py-2 font-mono text-sm"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Download Options -->
    <div class="border-t border-gray-700 pt-6 mt-6">
      <h3 class="text-xl font-semibold text-white mb-4">Download Options</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <%= form.label :enable_download, "Enable Download", class: "block text-sm font-medium mb-2" %>
          <div class="flex items-center">
            <%= form.check_box :enable_download, class: "mr-2 h-5 w-5 text-red-600 rounded focus:ring-red-500" %>
            <span class="text-gray-300">Allow users to download this movie</span>
          </div>
        </div>
        
        <div>
          <%= form.label :download_quality, "Download Quality", class: "block text-sm font-medium mb-2" %>
          <%= form.select :download_quality, options_for_select([['HD (1080p)', 'hd'], ['SD (720p)', 'sd'], ['Mobile (480p)', 'mobile']]), {}, { class: "w-full bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" } %>
        </div>
      </div>
      
      <div class="mt-4">
        <%= form.label :download_price, "Download Price ($)", class: "block text-sm font-medium mb-2" %>
        <%= form.number_field :download_price, step: 0.99, min: 0, value: 0, class: "w-full md:w-1/3 bg-gray-700 text-white rounded px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500" %>
        <p class="text-sm text-gray-400 mt-1">Set to 0 for free downloads</p>
      </div>
    </div>
    
    <div class="flex justify-end space-x-4 pt-4">
      <%= link_to "Cancel", admin_movies_path, class: "bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded" %>
      <%= form.submit "Create Movie", class: "bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded" %>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const adsContainer = document.getElementById('ads-container');
  const addAdBtn = document.getElementById('add-ad-btn');
  const adTemplate = document.getElementById('ad-template');
  let adCount = 0;

  // Add new ad
  addAdBtn.addEventListener('click', function() {
    adCount++;
    const newAd = adTemplate.cloneNode(true);
    newAd.classList.remove('hidden');
    newAd.id = '';
    
    // Update ad number
    const adNumber = newAd.querySelector('.ad-number');
    adNumber.textContent = adCount;
    
    // Update input names with unique indices
    const inputs = newAd.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
      const name = input.getAttribute('name');
      if (name) {
        input.setAttribute('name', name.replace('[0]', `[${adCount}]`));
      }
    });
    
    // Add remove functionality
    const removeBtn = newAd.querySelector('.remove-ad-btn');
    removeBtn.addEventListener('click', function() {
      newAd.remove();
      updateAdNumbers();
    });
    
    // Insert before the template
    adsContainer.insertBefore(newAd, adTemplate);
  });

  // Update ad numbers after removal
  function updateAdNumbers() {
    const ads = adsContainer.querySelectorAll('[id!="ad-template"]:not(.hidden)');
    ads.forEach((ad, index) => {
      const numberSpan = ad.querySelector('.ad-number');
      if (numberSpan) {
        numberSpan.textContent = index + 1;
      }
    });
    adCount = ads.length;
  }

  // Auto-ads feature - simulate automatic ad insertion
  const enableAdsCheckbox = document.querySelector('input[name="movie[enable_ads]"]');
  const adFrequencyInput = document.querySelector('input[name="movie[ad_frequency]"]');
  
  if (enableAdsCheckbox && adFrequencyInput) {
    enableAdsCheckbox.addEventListener('change', function() {
      if (this.checked) {
        // Auto-add a sample ad when enabling ads
        setTimeout(() => {
          if (adCount === 0) {
            addAdBtn.click();
            // Set default values for auto-added ad
            setTimeout(() => {
              const lastAd = adsContainer.querySelector('[id!="ad-template"]:not(.hidden):last-of-type');
              if (lastAd) {
                const titleInput = lastAd.querySelector('input[type="text"]');
                const urlInput = lastAd.querySelector('input[type="url"]');
                if (titleInput) titleInput.value = "Auto-generated Ad";
                if (urlInput) urlInput.value = "https://example.com/sample-ad";
              }
            }, 100);
          }
        }, 300);
      }
    });
  }
});
</script>